name: Build and Package Mods

on:
  push:
    tags:
      - 'v*'  # æ‰“ tag æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

jobs:
  build:
    name: Build & Package Mods
    runs-on: windows-latest

    strategy:
      matrix:
        dotnet: [ '8.0.x' ]

    steps:
    # 1ï¸âƒ£ æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£ å®‰è£… .NET SDK
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet }}

    # 3ï¸âƒ£ è¿˜åŸä¾èµ–
    - name: Restore dependencies
      run: dotnet restore

    # 4ï¸âƒ£ æ„å»º Modding.Coreï¼ˆå› ä¸ºå…¶ä»–æ¨¡å—ä¾èµ–å®ƒï¼‰
    - name: Build Core Library
      run: dotnet build ./src/Modding.Core/Modding.Core.csproj -c Release --no-restore
      env:
        CI: true

    # 5ï¸âƒ£ æ„å»ºå¹¶æ‰“åŒ…ä¸¤ä¸ªæ¨¡å—
    - name: Build CustomBaseBgm
      run: |
        dotnet build ./src/Modding.CustomBaseBgm/Modding.CustomBaseBgm.csproj -c Release --no-restore
        mkdir -Force ./publish/CustomBaseBgm
        Copy-Item ./src/Modding.CustomBaseBgm/bin/Release/* ./publish/CustomBaseBgm -Recurse
      env:
        CI: true

    - name: Build MusicEarphone
      run: |
        dotnet build ./src/Modding.MusicEarphone/Modding.MusicEarphone.csproj -c Release --no-restore
        mkdir -Force ./publish/MusicEarphone
        Copy-Item ./src/Modding.MusicEarphone/bin/Release/* ./publish/MusicEarphone -Recurse
      env:
        CI: true

    # 6ï¸âƒ£ å‹ç¼©ä¸¤ä¸ªåŒ…ï¼ˆå¸¦ç‰ˆæœ¬å·å’Œå¹³å°ä¿¡æ¯ï¼‰
    - name: Create ZIP packages
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        $os = "windows"
        Compress-Archive -Path ./publish/CustomBaseBgm/* -DestinationPath "./publish/CustomBaseBgm_${version}_${os}.zip"
        Compress-Archive -Path ./publish/MusicEarphone/* -DestinationPath "./publish/MusicEarphone_${version}_${os}.zip"


    # 7ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆç”¨äºåç»­ Releaseï¼‰
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mod-packages
        path: ./publish/*.zip

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')   # ä»…åœ¨æ‰“ tag æ—¶æ‰§è¡Œ

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: mod-packages
        path: ./artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ğŸµ è‡ªåŠ¨æ„å»ºçš„æ¸¸æˆ Mod åŒ…
          âœ… åŒ…å«ï¼š
            - CustomBaseBgmï¼ˆè‡ªå®šä¹‰èƒŒæ™¯éŸ³ä¹æ¨¡å—ï¼‰
            - MusicEarphoneï¼ˆéŸ³ä¹è€³æœºæ¨¡å—ï¼‰
          ğŸ•“ æ„å»ºæ—¶é—´ï¼š${{ github.run_id }}
        files: |
          ./artifacts/CustomBaseBgm_v*windows.zip
          ./artifacts/MusicEarphone_v*windows.zip

      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
